@page
@model Smotrilka_Web.Pages.IndexModel
@{
    ViewData["Title"] = "Главная";
}

<div class="container">
    <div class="hero-section">
        <h1>Найдите лучшие образовательные материалы</h1>
        <p>Откройте для себя курсы, лекции и учебные ресурсы со всего мира в одном месте</p>
    </div>

    <div class="search-container">
        <div class="search-input-container">
            <input type="text"
                   id="searchInput"
                   class="search-input"
                   placeholder="Введите название курса, тему, автора или ключевые слова..."
                   autocomplete="off" />
            <div class="search-icon">🔍</div>
        </div>

        <div class="search-results" id="searchResults">
            <!-- Результаты поиска будут появляться здесь динамически -->
        </div>
    </div>

    <div class="features-section">
        <h2>Почему выбирают Smotrilka?</h2>
        <div class="features-grid">
            <div class="feature-card">
                <h3>🎓 Качественный контент</h3>
                <p>Только проверенные образовательные материалы от экспертов в своих областях</p>
            </div>
            <div class="feature-card">
                <h3>🔍 Умный поиск</h3>
                <p>Быстрый и точный поиск по тысячам курсов с интеллектуальной фильтрацией</p>
            </div>
            <div class="feature-card">
                <h3>⭐ Персональное избранное</h3>
                <p>Сохраняйте понравившиеся материалы в свой личный кабинет для быстрого доступа</p>
            </div>
            <div class="feature-card">
                <h3>🏷️ Детальная информация</h3>
                <p>Полная информация о каждом курсе в удобном и наглядном формате стикеров</p>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchInput');
            const searchResults = document.getElementById('searchResults');
            let searchTimeout;

            searchInput.addEventListener('input', function(e) {
                clearTimeout(searchTimeout);
                const query = e.target.value.trim();

                if (query.length === 0) {
                    searchResults.innerHTML = '';
                    return;
                }

                // Показываем индикатор загрузки
                searchResults.innerHTML = '<div class="loading">🔍 Ищем образовательные материалы...</div>';

                searchTimeout = setTimeout(async () => {
                    try {
                        const response = await fetch(`http://158.160.120.54:9090/search?q=${encodeURIComponent(query)}`);

                        if (!response.ok) {
                            throw new Error('Ошибка поиска');
                        }

                        const results = await response.json();
                        displayResults(results);
                    } catch (error) {
                        console.error('Search error:', error);
                        searchResults.innerHTML = '<div class="error">⚠️ Ошибка при выполнении поиска. Пожалуйста, попробуйте позже.</div>';
                    }
                }, 400);
            });

            function displayResults(results) {
                if (results.length === 0) {
                    searchResults.innerHTML = `
                        <div class="no-results">
                            <p>По вашему запросу ничего не найдено</p>
                            <p class="search-tips">Попробуйте изменить запрос или использовать другие ключевые слова</p>
                        </div>`;
                    return;
                }

                const html = results.map(result => `
                    <div class="link-card fade-in">
                        <h3><a href="/Link?id=${result.id}">${escapeHtml(result.name)}</a></h3>
                        <div class="stickers-container">
                            ${result.tags ? result.tags.map(tag =>
                                `<span class="sticker">${escapeHtml(tag)}</span>`
                            ).join('') : ''}
                        </div>
                        <div class="link-meta">
                            <span class="rating">⭐ Рейтинг: ${result.rating || 0}</span>
                            <a href="${escapeHtml(result.link)}" target="_blank" rel="noopener" class="btn btn-secondary">
                                📚 Перейти к контенту
                            </a>
                        </div>
                    </div>
                `).join('');

                searchResults.innerHTML = html;
            }

            function escapeHtml(unsafe) {
                if (!unsafe) return '';
                return unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }

            // Фокус на поле поиска при загрузке
            searchInput.focus();
        });
    </script>
}